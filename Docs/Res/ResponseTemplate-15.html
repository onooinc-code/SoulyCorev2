<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HedraCore | تقرير تنفيذ نمط المستودع (Repository Pattern)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        :root {
            --bg-color: #12101c; --surface-color: #1c182c; --primary-color: #a450e8; --secondary-color: #00bcd4; --text-color: #e0e0e0; --header-color: #ffffff; --border-color: #3a3252; --shadow-color: rgba(164, 80, 232, 0.2); --success-color: #4caf50; --error-color: #f44336; --warning-color: #ff9800; --font-size-base: 1rem;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); line-height: 1.8; direction: rtl; font-size: var(--font-size-base); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 80px 20px; background: linear-gradient(135deg, rgba(28, 24, 44, 0.9), rgba(18, 16, 28, 0.95)); border-bottom: 3px solid var(--primary-color); margin-bottom: 50px; position: relative; overflow: hidden; }
        header h1 { font-size: 3.8em; color: var(--header-color); margin: 0; font-weight: 700; text-shadow: 0 0 20px var(--shadow-color); animation: fadeIn 1s ease-out; }
        header p { font-size: 1.4em; color: #b0a8d8; margin-top: 15px; animation: fadeIn 1.2s ease-out; }
        .section { animation: fadeIn 1s ease-out; animation-fill-mode: both; }
        h2 { font-size: 2.8em; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-top: 60px; margin-bottom: 30px; display: flex; align-items: center; gap: 15px; }
        h3 { font-size: 1.9em; color: var(--secondary-color); margin-top: 40px; margin-bottom: 20px; }
        .card { background-color: var(--surface-color); border-radius: 12px; padding: 25px 30px; margin-bottom: 25px; border: 1px solid var(--border-color); box-shadow: 0 8px 30px rgba(0,0,0,0.3); animation: slideInRight 0.8s ease-out; }
        .header-icon { width: 48px; height: 48px; color: var(--primary-color); flex-shrink: 0; }
        pre { background-color: #0d1117; padding: 20px; border-radius: 8px; margin: 25px 0; border: 1px solid var(--border-color); overflow-x: auto;}
        .card ul, .card ol { padding-right: 20px; }
        .card code { font-family: monospace; background: #2a243e; padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.9em; color: #c792ea; direction: ltr; display: inline-block; }
        footer { text-align: center; margin-top: 80px; padding: 30px; border-top: 1px solid var(--border-color); color: #888; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; direction: ltr; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: #2a243e; font-weight: 600; text-align: left;}
        tr { text-align: left; }
        td:first-child { font-weight: bold; color: var(--secondary-color); }
        .verdict { margin-top: 20px; padding: 20px; border-radius: 8px; font-weight: 600; background-color: rgba(76, 175, 80, 0.1); border-right: 5px solid var(--success-color); color: #a5d6a7; }
    </style>
     <script type="module">
        try {
            const mermaid = (await import('https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs')).default;
            mermaid.initialize({ startOnLoad: true, theme: 'dark', securityLevel: 'loose', fontFamily: '"Cairo", sans-serif' });
        } catch(e) { console.error("Could not load Mermaid.js", e); }
    </script>
</head>
<body class="arabic">
    <header>
        <h1 id="main-title">تنفيذ طبقة الوصول إلى البيانات (Repository Pattern)</h1>
        <p id="main-subtitle">تقرير رقم 15: شرح معماري للتغييرات وكيف تلبي المتطلبات</p>
    </header>

    <div class="container">
        <div class="section" style="animation-delay: 0.2s;">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                ملخص التنفيذ
            </h2>
            <div class="card">
                <p>لقد قمت بتنفيذ طلبك لإنشاء واجهات (Interfaces) موحدة للتعامل مع جدول <code>data_sources</code>. لتحقيق ذلك بأفضل طريقة ممكنة، طبقت **نمط المستودع (Repository Pattern)**. هذا النمط هو معيار صناعي يوفر طبقة تجريد قوية بين منطق التطبيق (Business Logic) وآلية الوصول إلى البيانات (Data Access Logic).</p>
                <p>تم إنشاء "مستودع" خاص بجدول <code>data_sources</code>، وهو الآن المسؤول الوحيد عن جميع عمليات القراءة والكتابة والتحديث. تم بعد ذلك تعديل نقاط النهاية API لتستخدم هذا المستودع بدلاً من كتابة استعلامات SQL مباشرة، مما يجعل الكود أكثر نظافة، قابلية للصيانة، وأسهل للاختبار في المستقبل.</p>
            </div>
        </div>
        
        <div class="section" style="animation-delay: 0.4s;">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2.25 2.25 0 003.072 0l-.548-.547a2.25 2.25 0 01.02-3.182l2.122-2.121a2.25 2.25 0 00-3.182-3.182L16.5 7.5M5.572 7.572a2.25 2.25 0 000 3.182l.547.547a2.25 2.25 0 01-3.182.02l-2.121-2.122a2.25 2.25 0 00-3.182 3.182L7.5 16.5m.518-4.471A2.25 2.25 0 0010.5 9.75h3.75a2.25 2.25 0 001.685-3.882" /></svg>
                شرح نمط المستودع (Repository Pattern)
            </h2>
            <div class="card">
                <p>تخيل أن قاعدة البيانات هي مكتبة ضخمة. بدلاً من أن يذهب كل شخص ليبحث عن الكتب بنفسه (مما قد يسبب فوضى)، يوجد "أمين مكتبة" واحد فقط. أنت تطلب منه ما تريد ("أعطني هذا الكتاب"، "احفظ هذا المستند") وهو يعرف بالضبط أين يجد الأشياء وكيف ينظمها.</p>
                <p>في مشروعنا، <strong>المستودع (Repository) هو أمين المكتبة</strong>. نقاط الـ API لا تتحدث مباشرة مع قاعدة البيانات، بل تتحدث مع المستودع، والمستودع هو من يقوم بالعمل الفعلي.</p>
                <pre dir="ltr">
                    graph TD
                        A["API Routes (e.g., /api/data-sources)"] -- "Requests data" --> B["DataSource Repository"];
                        B -- "Executes SQL" --> C["Postgres Database (`data_sources` table)"];
                        C -- "Returns raw data" --> B;
                        B -- "Returns structured object" --> A;
                </pre>
            </div>
        </div>
        
        <div class="section" style="animation-delay: 0.6s;">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
                التنفيذ الفعلي
            </h2>
            <div class="card">
                <h3>1. الواجهة (العقد) - <code>IDataSourceRepository.ts</code></h3>
                <p>هذا الملف يحدد "العقد" أو القواعد التي يجب أن يلتزم بها أي مستودع لمصادر البيانات. إنه يجبرنا على توفير جميع الوظائف المطلوبة.</p>
                <pre dir="ltr"><code class="language-typescript">
export interface IDataSourceRepository {
  getById(id: string): Promise<DataSource | null>;
  getByName(name: string): Promise<DataSource | null>;
  getAll(): Promise<DataSource[]>;
  save(source: Partial<DataSource>): Promise<DataSource>;
  delete(id: string): Promise<void>;
}
                </code></pre>
            </div>
            <div class="card">
                <h3>2. التنفيذ الفعلي - <code>PostgresDataSourceRepository.ts</code></h3>
                <p>هذا الملف هو "أمين المكتبة" الفعلي. يحتوي على كل استعلامات SQL وينفذ العقد الذي حددته الواجهة. من أهم النقاط فيه هو دمج وظيفتي الحفظ والتحديث في دالة واحدة ذكية <code>save()</code>.</p>
                <pre dir="ltr"><code class="language-typescript">
// A simplified view of the save method logic
async save(source: Partial<DataSource>): Promise<DataSource> {
  if (source.id) {
    // If an ID exists, it's an UPDATE operation
    // ... logic to update the existing record
  } else {
    // If no ID, it's a CREATE (INSERT) operation
    // ... logic to create a new record
  }
}
                </code></pre>
            </div>
            <div class="card">
                <h3>3. إعادة هيكلة نقاط الـ API</h3>
                <p>أصبحت نقاط النهاية الآن أبسط وأنظف بكثير. بدلاً من احتوائها على كود SQL معقد، هي فقط تستدعي الوظائف من المستودع.</p>
                <pre dir="ltr"><code class="language-typescript">
// Example: app/api/data-sources/route.ts

// BEFORE:
// import { sql } from '@/lib/db';
// const { rows } = await sql`SELECT * FROM data_sources...`;

// AFTER:
import { PostgresDataSourceRepository } from '@/core/repositories/PostgresDataSourceRepository';
const repository = new PostgresDataSourceRepository();
const dataSources = await repository.getAll();
                </code></pre>
            </div>
        </div>

        <div class="section" style="animation-delay: 0.8s;">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                كيف يلبي هذا التنفيذ متطلباتك؟
            </h2>
            <div class="card">
                <p>لقد تم تلبية جميع متطلباتك الأربعة بكفاءة من خلال هذا النمط الموحد:</p>
                <ol>
                    <li><strong>حفظ البيانات:</strong> يتم عبر دالة <code>repository.save()</code> التي تتعامل مع الإنشاء الجديد.</li>
                    <li><strong>استرجاع البيانات:</strong> يتم عبر دوال <code>repository.getById()</code> و <code>repository.getAll()</code>.</li>
                    <li><strong>تحديث البيانات:</strong> يتم عبر نفس دالة <code>repository.save()</code> التي تتحقق من وجود <code>id</code> لتقوم بالتحديث.</li>
                    <li><strong>فحص وجود البيانات:</strong> يتم عبر دالة <code>repository.getByName()</code>، حيث يمكننا التحقق مما إذا كانت النتيجة <code>null</code> أم لا قبل إنشاء سجل جديد بنفس الاسم.</li>
                </ol>
                <div class="verdict">
                    <strong>النتيجة:</strong> لقد قمنا بتلبية جميع المتطلبات الحالية وبناء أساس متين للمستقبل. هذا النمط سيجعل إضافة مصادر بيانات جديدة أو حتى تغيير نوع قاعدة البيانات بالكامل (إذا احتجنا لذلك) أمرًا أسهل بكثير في المستقبل.
                </div>
            </div>
        </div>
    </div>
    <footer>
        <p>HedraCore Cognitive Architecture v3.0 - © 2025</p>
    </footer>
</body>
</html>
