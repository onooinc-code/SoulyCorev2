
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HedraCore | شرح شامل لنظام سير العمل (Workflow System)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        :root {
            --bg-color: #12101c; --surface-color: #1c182c; --primary-color: #a450e8; --secondary-color: #00bcd4; --text-color: #e0e0e0; --header-color: #ffffff; --border-color: #3a3252; --shadow-color: rgba(164, 80, 232, 0.2); --success-color: #4caf50; --error-color: #f44336; --warning-color: #ff9800; --font-size-base: 1rem;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); line-height: 1.8; direction: rtl; font-size: var(--font-size-base); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 80px 20px; background: linear-gradient(135deg, rgba(28, 24, 44, 0.9), rgba(18, 16, 28, 0.95)); border-bottom: 3px solid var(--primary-color); margin-bottom: 50px; position: relative; overflow: hidden; }
        header h1 { font-size: 3.8em; color: var(--header-color); margin: 0; font-weight: 700; text-shadow: 0 0 20px var(--shadow-color); animation: fadeIn 1s ease-out; }
        header p { font-size: 1.4em; color: #b0a8d8; margin-top: 15px; animation: fadeIn 1.2s ease-out; }
        .section { animation: fadeIn 1s ease-out; animation-fill-mode: both; }
        h2 { font-size: 2.8em; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-top: 60px; margin-bottom: 30px; display: flex; align-items: center; gap: 15px; }
        h3 { font-size: 1.9em; color: var(--secondary-color); margin-top: 40px; margin-bottom: 20px; }
        .card { background-color: var(--surface-color); border-radius: 12px; padding: 25px 30px; margin-bottom: 25px; border: 1px solid var(--border-color); box-shadow: 0 8px 30px rgba(0,0,0,0.3); animation: slideInRight 0.8s ease-out; }
        .header-icon { width: 48px; height: 48px; color: var(--primary-color); flex-shrink: 0; }
        pre { background-color: #0d1117; padding: 20px; border-radius: 8px; margin: 25px 0; border: 1px solid var(--border-color); overflow-x: auto;}
        .card ul, .card ol { padding-right: 20px; }
        .card code { font-family: monospace; background: #2a243e; padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.9em; color: #c792ea; direction: ltr; display: inline-block; }
        footer { text-align: center; margin-top: 80px; padding: 30px; border-top: 1px solid var(--border-color); color: #888; }
        blockquote { background-color: rgba(0, 188, 212, 0.05); border-right: 5px solid var(--secondary-color); padding: 15px 20px; margin: 20px 0; border-radius: 8px; font-style: italic; }
    </style>
     <script type="module">
        try {
            const mermaid = (await import('https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.js')).default;
            mermaid.initialize({ startOnLoad: true, theme: 'dark', securityLevel: 'loose', fontFamily: '"Cairo", sans-serif' });
        } catch(e) { console.error("Could not load Mermaid.js", e); }
    </script>
</head>
<body class="arabic">
    <header>
        <h1 id="main-title">شرح شامل لنظام سير العمل (Workflow System)</h1>
        <p id="main-subtitle">تقرير رقم 6: تحليل معماري، تفاصيل تقنية، والخطوات التالية</p>
    </header>

    <div class="container">
        <div class="section" style="animation-delay: 0.2s;">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2.25 2.25 0 003.072 0l-.548-.547a2.25 2.25 0 01.02-3.182l2.122-2.121a2.25 2.25 0 00-3.182-3.182L16.5 7.5M5.572 7.572a2.25 2.25 0 000 3.182l.547.547a2.25 2.25 0 01-3.182.02l-2.121-2.122a2.25 2.25 0 00-3.182 3.182L7.5 16.5m.518-4.471A2.25 2.25 0 0010.5 9.75h3.75a2.25 2.25 0 001.685-3.882" /></svg>
                المفهوم الأساسي: من "Prompt" إلى "Workflow"
            </h2>
            <div class="card">
                <h3>تشبيه من الواقع: الوصفة الذكية</h3>
                <p>فكر في الـ "Prompt" العادي على أنه خطوة واحدة في وصفة طبخ (مثل "اقطع البصل"). أما الـ "Workflow" (سير العمل) فهو الوصفة الكاملة الذكية. أنت تعطيها المكونات الأولية (المدخلات)، وهي تتبع الخطوات بالتسلسل، وتستخدم نتيجة كل خطوة في الخطوة التالية، حتى تصل إلى الطبق النهائي.</p>
                <blockquote>الهدف من نظام سير العمل هو تحويل الذكاء الاصطناعي من "مساعد" يجيب على سؤال واحد، إلى "عامل آلي" ينفذ سلسلة من المهام المعقدة لتحقيق هدف نهائي.</blockquote>
                <p>هذا يسمح لنا بأتمتة مهام مثل: "لخص هذا المستند الطويل، ثم استخرج منه النقاط الرئيسية، ثم اكتب بريدًا إلكترونيًا يحتوي على هذه النقاط، وأخيرًا اقترح عنوانًا للبريد الإلكتروني". كل هذا بضغطة زر واحدة.</p>
            </div>
        </div>

        <div class="section" style="animation-delay: 0.4s;">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
                البنية المعمارية وتدفق التنفيذ
            </h2>
            <div class="card">
                <p>يعتمد النظام على تنسيق بين الواجهة الأمامية (Client-side) والواجهة الخلفية (Server-side). الواجهة الأمامية هي "المايسترو" الذي يدير تسلسل الخطوات، بينما الواجهة الخلفية هي "العازف" الذي ينفذ كل خطوة على حدة.</p>
                <pre dir="ltr">
                    graph TD
                        subgraph Client-Side (Browser)
                            A[1. User triggers Workflow via ChatInput.tsx] --> B[2. `startWorkflow` in ConversationProvider.tsx];
                            B --> C{Loop until all steps are done};
                            C --> D[3. Prepare current step's prompt (interpolate variables)];
                            D --> E[4. Call `addMessage` to execute the step];
                        end

                        subgraph Server-Side (API)
                            F["`/api/chat` Endpoint"] --> G["Gemini AI Model"];
                            G --> H["AI Response"];
                        end
                        
                        subgraph Database
                            I["`prompts` table"]
                        end

                        E -- "HTTP POST" --> F;
                        H -- "HTTP Response" --> E;
                        C -- "Fetch next step's prompt" --> I;
                        
                        style A fill:#a450e8,stroke:#fff,stroke-width:2px,color:#000
                        style B fill:#00bcd4,stroke:#fff,stroke-width:2px,color:#000
                </pre>
            </div>
        </div>

        <div class="section" style="animation-delay: 0.6s;">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                تفاصيل المكونات والملفات الرئيسية
            </h2>
            <div class="card">
                <ul>
                    <li><strong><code>PromptsHub.tsx</code>:</strong> واجهة المستخدم الرئيسية لإدارة جميع الـ prompts، بما في ذلك إنشاء وتعديل الـ Workflows.</li>
                    <li><strong><code>WorkflowBuilder.tsx</code>:</strong> مكون متخصص داخل الـ Hub، يوفر واجهة السحب والإفلات لترتيب الخطوات وتحديد مدخلاتها.</li>
                    <li><strong><code>ChatInput.tsx</code>:</strong> مسؤول عن "مشغل الـ Prompts" (Prompt Launcher) الذي يسمح للمستخدم باختيار وبدء سير العمل.</li>
                    <li><strong><code>ConversationProvider.tsx</code>:</strong> هو العقل المدبر في الواجهة الأمامية. يحتوي على دالة <code>startWorkflow</code> التي تبدأ العملية ودالة <code>executeNextWorkflowStep</code> التي تدير الحلقة التكرارية لتنفيذ الخطوات.</li>
                    <li><strong><code>app/api/prompts/[promptId]/route.ts</code>:</strong> نقطة النهاية الخلفية لجلب تعريف prompt فردي (محتوى الخطوة الحالية).</li>
                    <li><strong><code>app/api/chat/route.ts</code>:</strong> نقطة النهاية القوية التي نستخدمها لتنفيذ كل خطوة من خطوات سير العمل. لا نحتاج إلى API جديد، بل نعيد استخدام نفس الـ API الخاص بالمحادثة العادية.</li>
                </ul>
            </div>
        </div>

        <div class="section" style="animation-delay: 0.8s;">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                التفاصيل التقنية: بنية `chain_definition`
            </h2>
            <div class="card">
                <p>يتم تخزين تعريف سير العمل في قاعدة البيانات في جدول <code>prompts</code> داخل حقل JSONB يسمى <code>chain_definition</code>. هذه هي البنية الدقيقة له:</p>
                <pre dir="ltr"><code class="language-json">
[
  {
    "step": 1,
    "promptId": "uuid-of-summarize-prompt",
    "inputMapping": {
      "text_to_summarize": { "source": "userInput" }
    }
  },
  {
    "step": 2,
    "promptId": "uuid-of-extract-points-prompt",
    "inputMapping": {
      "summary_text": { "source": "stepOutput", "step": 1 }
    }
  },
  {
    "step": 3,
    "promptId": "uuid-of-write-email-prompt",
    "inputMapping": {
      "key_points": { "source": "stepOutput", "step": 2 },
      "recipient_name": { "source": "userInput" }
    }
  }
]
                </code></pre>
                <ul>
                    <li><code>step</code>: رقم تسلسلي يحدد ترتيب التنفيذ.</li>
                    <li><code>promptId</code>: معرّف الـ prompt "الفردي" الذي سيتم تنفيذه في هذه الخطوة.</li>
                    <li><code>inputMapping</code>: كائن يحدد كيفية ملء المتغيرات داخل الـ prompt.
                        <ul>
                            <li><code>source: "userInput"</code>: يعني أن القيمة ستأتي من المدخلات الأولية التي قدمها المستخدم عند بدء سير العمل.</li>
                            <li><code>source: "stepOutput", "step": X</code>: يعني أن القيمة هي المخرج (النتيجة) الكاملة للخطوة رقم X.</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="section" style="animation-delay: 1.0s;">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="header-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                الخطوات التالية
            </h2>
            <div class="card">
                <p>هذا النظام يؤسس بنية تحتية قوية للغاية. في المستقبل، يمكننا توسيعه بسهولة ليشمل:</p>
                <ul>
                    <li><strong>المنطق الشرطي (Conditional Logic):</strong> إضافة خطوات "إذا/وإلا" (if/else) بناءً على مخرجات الخطوات السابقة.</li>
                    <li><strong>التفرع والتوازي (Branching & Parallel Execution):</strong> تشغيل عدة خطوات بالتوازي لتسريع العمليات.</li>
                    <li><strong>استخدام الأدوات (Tool Use):</strong> السماح لخطوة في سير العمل باستدعاء "أداة" (مثل البحث على الويب أو تشغيل كود) بدلاً من مجرد prompt.</li>
                </ul>
                <p>بناءً على هذا الشرح المفصل، هل توافق على أن هذه البنية قوية ومناسبة؟ وهل يمكننا اعتبار هذه الميزة "مكتملة" من الناحية التأسيسية والانتقال إلى المهام التالية؟</p>
            </div>
        </div>
    </div>
    <footer>
        <p>HedraCore Cognitive Architecture v3.0 - © 2025</p>
    </footer>
</body>
</html>
